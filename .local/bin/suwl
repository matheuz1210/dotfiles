#!/bin/zsh
# suwl: run wayland program as another user

newuser=${1?}
shift

if [[ $WAYLAND_DISPLAY[1] != '/' ]] {
	WAYLAND_DISPLAY=$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY
}
: ${PULSE_SERVER:=$XDG_RUNTIME_DIR/pulse/native}

setfacl -m u:${newuser}:x   -- ${WAYLAND_DISPLAY:h}
setfacl -m u:${newuser}:rwx -- $WAYLAND_DISPLAY
setfacl -m u:${newuser}:rwx -- $WAYLAND_DISPLAY.lock

setfacl -m u:${newuser}:x   -- ${PULSE_SERVER:h}
setfacl -m u:${newuser}:x   -- $PULSE_SERVER

exec su $newuser -c "env WAYLAND_DISPLAY=${(q)WAYLAND_DISPLAY} PULSE_SERVER=${(q)PULSE_SERVER} "${(j[ ])${(q)@}}
